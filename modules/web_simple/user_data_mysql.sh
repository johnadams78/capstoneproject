#!/bin/bash
yum update -y && yum install -y httpd php php-mysqlnd mysql
systemctl start httpd && systemctl enable httpd
DB_EP="${db_endpoint}"
DB_NM="${db_name}"
DB_US="${db_username}"
DB_PW="${db_password}"
echo "Waiting for RDS..." && for i in {1..60};do mysqladmin ping -h "$DB_EP" -u "$DB_US" -p"$DB_PW" --silent 2>/dev/null && break || sleep 10;done
cat>/var/www/html/index.php<<'E'
<?php
$h='DB_H';$n='DB_N';$u='DB_U';$p='DB_P';
try{$d=new PDO("mysql:host=$h;dbname=$n",$u,$p);$d->setAttribute(PDO::ATTR_ERRMODE,PDO::ERRMODE_EXCEPTION);$d->exec("CREATE TABLE IF NOT EXISTS cars(id INT AUTO_INCREMENT PRIMARY KEY,make VARCHAR(50),model VARCHAR(50),year INT,price DECIMAL(10,2),mileage INT,color VARCHAR(30),description TEXT,image_url VARCHAR(255))");if($d->query("SELECT COUNT(*) FROM cars")->fetchColumn()==0){$s=$d->prepare("INSERT INTO cars VALUES(NULL,?,?,?,?,?,?,?,?)");$c=[['Toyota','Camry',2023,32500,8000,'White','Excellent','https://loremflickr.com/400/300/car?lock=1'],['Honda','Civic',2023,26500,11000,'Blue','Reliable','https://loremflickr.com/400/300/car?lock=2'],['Ford','F-150',2023,45000,6000,'Black','Best seller','https://loremflickr.com/400/300/truck?lock=3'],['BMW','3 Series',2023,48000,5000,'Gray','Luxury','https://loremflickr.com/400/300/car?lock=4'],['Mercedes','C-Class',2023,51000,6000,'Silver','Premium','https://loremflickr.com/400/300/car?lock=5'],['Audi','A4',2023,46900,7500,'Blue','Tech','https://loremflickr.com/400/300/car?lock=6'],['Nissan','Altima',2023,29500,9000,'Red','Mid-size','https://loremflickr.com/400/300/car?lock=7'],['Hyundai','Elantra',2023,25900,7000,'Blue','Compact','https://loremflickr.com/400/300/car?lock=8'],['Kia','Forte',2023,24500,8500,'Red','Value','https://loremflickr.com/400/300/car?lock=9'],['VW','Jetta',2023,27900,6000,'White','German','https://loremflickr.com/400/300/car?lock=10'],['Subaru','Impreza',2023,26500,8000,'Orange','AWD','https://loremflickr.com/400/300/car?lock=11'],['Toyota','Corolla',2022,24900,15000,'Silver','Efficient','https://loremflickr.com/400/300/car?lock=12'],['Honda','Accord',2022,31000,14000,'Black','Popular','https://loremflickr.com/400/300/car?lock=13'],['Ford','Mustang',2022,39900,13000,'Red','Sports','https://loremflickr.com/400/300/car?lock=14'],['BMW','X3',2022,52000,12000,'Black','SUV','https://loremflickr.com/400/300/suv?lock=15'],['Mercedes','GLC',2022,55900,11000,'White','Luxury SUV','https://loremflickr.com/400/300/suv?lock=16'],['Audi','Q5',2022,52500,13000,'White','Premium SUV','https://loremflickr.com/400/300/suv?lock=17'],['Nissan','Sentra',2022,22900,14000,'White','Efficient','https://loremflickr.com/400/300/car?lock=18'],['Hyundai','Sonata',2022,31500,12000,'White','Spacious','https://loremflickr.com/400/300/car?lock=19'],['Kia','Sportage',2022,30500,13500,'Black','Compact SUV','https://loremflickr.com/400/300/suv?lock=20'],['Toyota','RAV4',2022,36900,12000,'Blue','AWD','https://loremflickr.com/400/300/suv?lock=21'],['Honda','CR-V',2022,34900,7000,'White','Family','https://loremflickr.com/400/300/suv?lock=22'],['Ford','Explorer',2022,42500,9500,'Black','7-seater','https://loremflickr.com/400/300/suv?lock=23'],['Nissan','Rogue',2022,33900,8000,'Silver','Family SUV','https://loremflickr.com/400/300/suv?lock=24'],['Toyota','Prius',2021,27500,22000,'Green','Hybrid','https://loremflickr.com/400/300/car?lock=25'],['Honda','Pilot',2021,41500,19000,'Silver','8-seater','https://loremflickr.com/400/300/suv?lock=26'],['Ford','Edge',2021,32000,28000,'Gray','Mid SUV','https://loremflickr.com/400/300/suv?lock=27'],['BMW','X5',2021,65000,20000,'Blue','Luxury SUV','https://loremflickr.com/400/300/suv?lock=28'],['Audi','Q7',2021,63000,18000,'Gray','7-seater','https://loremflickr.com/400/300/suv?lock=29'],['Nissan','Pathfinder',2021,41000,16000,'Blue','8-seater','https://loremflickr.com/400/300/suv?lock=30'],['Toyota','Highlander',2021,42000,18000,'Black','8-seater','https://loremflickr.com/400/300/suv?lock=31'],['Ford','Escape',2021,28900,17000,'White','Compact','https://loremflickr.com/400/300/suv?lock=32'],['Mazda','CX-5',2021,35900,15000,'Blue','Fun SUV','https://loremflickr.com/400/300/suv?lock=33'],['Jeep','Cherokee',2021,38900,14000,'Red','Off-road','https://loremflickr.com/400/300/suv?lock=34'],['Lexus','RX',2021,58900,12000,'Pearl','Luxury','https://loremflickr.com/400/300/car?lock=35'],['Acura','MDX',2021,52900,16000,'Black','Premium','https://loremflickr.com/400/300/suv?lock=36'],['Infiniti','QX60',2021,49900,18000,'Silver','7-seater','https://loremflickr.com/400/300/suv?lock=37'],['Cadillac','XT5',2021,55900,13000,'White','American Luxury','https://loremflickr.com/400/300/suv?lock=38'],['Lincoln','Aviator',2021,62900,11000,'Black','Premium SUV','https://loremflickr.com/400/300/suv?lock=39'],['Volvo','XC90',2021,57900,14000,'Blue','Safety first','https://loremflickr.com/400/300/suv?lock=40'],['Genesis','GV70',2021,54900,9000,'Gray','Luxury brand','https://loremflickr.com/400/300/suv?lock=41'],['Alfa Romeo','Stelvio',2021,48900,12000,'Red','Italian style','https://loremflickr.com/400/300/suv?lock=42'],['Tesla','Model Y',2021,67900,8000,'White','Electric SUV','https://loremflickr.com/400/300/car?lock=43'],['Porsche','Macan',2021,72900,5000,'Black','Sports SUV','https://loremflickr.com/400/300/car?lock=44'],['Land Rover','Discovery',2021,68900,13000,'Green','Adventure','https://loremflickr.com/400/300/suv?lock=45'],['Jaguar','F-PACE',2021,59900,11000,'Gray','British luxury','https://loremflickr.com/400/300/suv?lock=46'],['Maserati','Levante',2021,89900,7000,'Blue','Italian luxury','https://loremflickr.com/400/300/car?lock=47'],['Bentley','Bentayga',2021,229900,3000,'Black','Ultra luxury','https://loremflickr.com/400/300/car?lock=48'],['Rolls-Royce','Cullinan',2021,389900,2000,'Silver','Peak luxury','https://loremflickr.com/400/300/car?lock=49'],['Ferrari','Purosangue',2023,449900,500,'Red','Sports SUV','https://loremflickr.com/400/300/car?lock=50'],['Lamborghini','Urus',2022,249900,1500,'Yellow','Super SUV','https://loremflickr.com/400/300/car?lock=51'],['McLaren','GT',2022,219900,1200,'Orange','British supercar','https://loremflickr.com/400/300/car?lock=52']];foreach($c as $v)$s->execute($v);}}catch(PDOException $e){die("DB error: ".$e->getMessage());}$q=$_GET;$w=[];$x=[];if(@$q['search']){$w[]="(make LIKE ? OR model LIKE ?)";$x[]=$x[]="%{$q['search']}%";}if(@$q['make']){$w[]="make=?";$x[]=$q['make'];}if(@$q['year']){$w[]="year=?";$x[]=$q['year'];}if(@$q['color']){$w[]="color=?";$x[]=$q['color'];}if(@$q['price_min']){$w[]="price>=?";$x[]=$q['price_min'];}if(@$q['price_max']){$w[]="price<=?";$x[]=$q['price_max'];}$o=@$q['sort']=='price_asc'?'price ASC':(@$q['sort']=='price_desc'?'price DESC':'year DESC');$t=$d->prepare("SELECT * FROM cars ".($w?"WHERE ".implode(' AND ',$w):'')." ORDER BY $o");$t->execute($x);$r=$t->fetchAll(PDO::FETCH_ASSOC);$mk=$d->query("SELECT DISTINCT make FROM cars ORDER BY make")->fetchAll(PDO::FETCH_COLUMN);$yr=$d->query("SELECT DISTINCT year FROM cars ORDER BY year DESC")->fetchAll(PDO::FETCH_COLUMN);$cl=$d->query("SELECT DISTINCT color FROM cars ORDER BY color")->fetchAll(PDO::FETCH_COLUMN);?><!DOCTYPE html><html><head><title>Capstone Car Dealer</title><style>body{font-family:Arial;margin:20px;background:#f4f4f4}.header{background:linear-gradient(135deg,#2c3e50,#3498db);color:#fff;padding:1rem;margin:-20px -20px 20px}.search{background:#fff;padding:20px;margin-bottom:20px;border-radius:8px;text-align:center}.search input,.search select{padding:8px;border:1px solid #ddd;border-radius:4px;margin:2px}.search button{padding:8px 15px;background:#3498db;color:#fff;border:none;border-radius:4px;cursor:pointer}.cars{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px}.car{background:#fff;padding:20px;border-radius:12px}.car img{width:100%;height:200px;object-fit:cover;border-radius:8px;margin-bottom:10px}.price{font-size:1.5rem;font-weight:bold;color:#27ae60}</style></head><body><div class="header"><h1>ðŸš— Capstone Car Dealer</h1><p>Powered by AWS Aurora RDS</p></div><div class="search"><form method="GET"><input type="text" name="search" placeholder="Search..." value="<?=@$q['search']?>"><select name="make"><option value="">Make</option><?php foreach($mk as $m):?><option value="<?=$m?>"<?=@$q['make']==$m?' selected':''?>><?=$m?></option><?php endforeach;?></select><select name="year"><option value="">Year</option><?php foreach($yr as $y):?><option value="<?=$y?>"<?=@$q['year']==$y?' selected':''?>><?=$y?></option><?php endforeach;?></select><select name="color"><option value="">Color</option><?php foreach($cl as $c):?><option value="<?=$c?>"<?=@$q['color']==$c?' selected':''?>><?=$c?></option><?php endforeach;?></select><input type="number" name="price_min" placeholder="Min $" value="<?=@$q['price_min']?>"><input type="number" name="price_max" placeholder="Max $" value="<?=@$q['price_max']?>"><select name="sort"><option value="year_desc"<?=@$q['sort']=='year_desc'?' selected':''?>>Newest</option><option value="price_asc"<?=@$q['sort']=='price_asc'?' selected':''?>>Low $</option><option value="price_desc"<?=@$q['sort']=='price_desc'?' selected':''?>>High $</option></select><button type="submit">Filter</button></form><p><strong><?=count($r)?></strong> vehicles found</p></div><div class="cars"><?php foreach($r as $car):?><div class="car"><img src="<?=$car['image_url']?>" alt="<?=$car['year']?> <?=$car['make']?> <?=$car['model']?>"><h3><?=$car['year']?> <?=$car['make']?> <?=$car['model']?></h3><div class="price">$<?=number_format($car['price'],0)?></div><p><strong>Mileage:</strong> <?=number_format($car['mileage'])?> mi | <strong>Color:</strong> <?=$car['color']?></p><p><?=$car['description']?></p></div><?php endforeach;?></div></body></html>
E
sed -i "s/DB_H/$DB_EP/;s/DB_N/$DB_NM/;s/DB_U/$DB_US/;s/DB_P/$DB_PW/" /var/www/html/index.php
cat>/var/www/html/health.php<<'H'
<?php header('Content-Type:application/json');$h='DB_H';$n='DB_N';$u='DB_U';$p='DB_P';try{$d=new PDO("mysql:host=$h;dbname=$n",$u,$p);$s='connected';$c=$d->query("SELECT COUNT(*) FROM cars")->fetchColumn();}catch(PDOException $e){$s='disconnected';$c=0;}echo json_encode(['status'=>'healthy','database'=>['type'=>'Aurora MySQL','status'=>$s,'endpoint'=>$h,'cars_count'=>$c]]);?>
H
sed -i "s/DB_H/$DB_EP/;s/DB_N/$DB_NM/;s/DB_U/$DB_US/;s/DB_P/$DB_PW/" /var/www/html/health.php
chown -R apache:apache /var/www/html && systemctl restart httpd
echo "Car Dealer with Aurora RDS deployed!"
